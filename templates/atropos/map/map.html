{% extends "base.html" %}

{% block wrapper %}
<style>
#my_gmap {
    width: 100%;
    height: 400px;
    display: block;
    /*-webkit-filter: grayscale(100%);
    -moz-filter: grayscale(100%);
    -ms-filter: grayscale(100%);
    -o-filter: grayscale(100%);
    filter: grayscale(100%);*/
    filter: url(data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter i…0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscale);
    filter: gray;
    z-index: 1;
    }
</style>
		<div id="wrapper">
			<section class="container top-no-header">
				<div style='margin-bottom: 40px;' id="my_gmap"></div>

                {% block map_content %}{% endblock %}

            </section>
		</div>
<script>
    var map;
    function initMap() {
        // set map settings
        map = new google.maps.Map(document.getElementById('my_gmap'), {
            center: {lat: 50.448, lng: 30.52},
            zoom: 12
        });

		var infoWin = new google.maps.InfoWindow();
		// Add some markers to the map.
		// Note: The code uses the JavaScript Array.prototype.map() method to
		// create an array of markers based on a given "locations" array.
		// The map() method here has nothing to do with the Google Maps API.
		var markers = locations.map(function(location, i) {
			var marker = new google.maps.Marker({
		        position: location
		    });
		    google.maps.event.addListener(marker, 'click', function(evt) {
		        infoWin.setContent(location.info);
		        infoWin.open(map, marker);
		    })
		    return marker;
		});

		// Add a marker clusterer to manage the markers.
		var markerCluster = new MarkerClusterer(map, markers, {
			imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'
		});

        // recenter while resize window
        var currCenter = map.getCenter();
        google.maps.event.addDomListener(window, 'resize', function() {
            map.setCenter(currCenter);
        });
        google.maps.event.addListener(map, 'idle', function(){
            currCenter = map.getCenter();
        });
    }

    var locations = [
	{% for instance in instances %}
	{% for location in instance.locations.all %}
	{% if location.coordinates.lat and location.coordinates.lng %}

	{
	lat: {{ location.coordinates.lat }},
	lng: {{ location.coordinates.lng }},
	//title: '{{ instance.title }}',
	info: '<div>'+
			'<h3>{{ instance.title }}</h3>'+
			{% if instance.image %}
			'<div class="text-center">'+
				'<img alt="{{ instance.title }}" class="img-responsive" src="{{ instance.image.url }}" style="max-width:200px"/>'+
			'</div>'+
			{% endif %}
			'<div class="popover-content">'+
			{% for link in instance.links.all %}
				'<a href="{{ link }}" target="_blank">'+
				'Перейти</a>'+
			{% endfor %}
			'</div>'+
		   '</div>'
	},

	{% endif %}
	{% endfor %}
	{% endfor %}
	]
</script>

<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSeJVa4nfu8wrpf_C9UuwLTuqVjoTZ2-E&callback=initMap">
</script>
{% endblock %}